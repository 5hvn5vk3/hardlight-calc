# 仕様書: Chrome拡張「ハードライト合成色逆算」

## 1. 目的

Web上の任意の2色（基本色・結果色）をスポイトで取得し、ハードライト合成の逆算により合成色を求める。  
求めた値を `基本色: #xxxxxx, 合成色: #xxxxxx` 形式でクリップボードへ保存する。

---

## 2. 対象環境

- Chrome Extension Manifest V3
- 対応ブラウザ: EyeDropper API が利用可能な Chrome
- 言語: TypeScript（`strict: true`）
- UI: 素の HTML/CSS/TS（フレームワーク不使用）
- テスト: Vitest

---

## 3. 機能要件

### 3.1 ユーザーフロー

1. 拡張を開くと、`基本色のスポイトを開始` ボタンを表示。
2. ボタン押下で EyeDropper 起動。
3. 取得色を基本色として保持。
4. EyeDropper終了後、`結果色を取得する` ボタンを表示。
5. ボタン押下で再度 EyeDropper 起動。
6. 取得色を結果色として保持し、逆算処理を実行。
7. 成功時、以下文字列をクリップボードに保存。  
   `基本色: #rrggbb, 合成色: #rrggbb`
8. 成功時トーストを一時表示。  
   `基本色と合成色がクリップボードに保存されました`

### 3.2 エラー時

- 基本色の取得に失敗した場合: エラーメッセージ表示、状態は `idle` を維持
- 結果色の取得に失敗した場合: エラーメッセージ表示、状態は `basePicked` を維持
- EyeDropperキャンセル: 状態を維持し、再試行可能
- EyeDropper非対応: エラーメッセージ表示
- クリップボード保存失敗: エラーメッセージ表示、コピー失敗として扱う

---

## 4. 計算仕様（最重要）

### 4.1 前提

- RGB各チャネルを独立計算（0..255 整数）
- 正方向ハードライト関数 `hardLight(base, blend)` を以下で定義:
  - `base == 0` のとき: `round(255 - (2 * (255 - base) * (255 - blend)) / 255)`
  - `base == 255` のとき: `round((2 * base * blend) / 255)`
  - 上記以外で `blend < 128` のとき: `round((2 * base * blend) / 255)`
  - 上記以外で `blend >= 128` のとき: `round(255 - (2 * (255 - base) * (255 - blend)) / 255)`
- 丸め: `Math.round`
- 最終値は `clamp(0,255)`

### 4.2 逆算アルゴリズム（チャネルごと）

入力: `base`, `result`  
出力: `blend`（合成色チャネル）, `error`（チャネル誤差）

1. `s = 0..255` を全探索
2. 4.1の定義（`base == 0` / `base == 255` 特例を含む）で `pred = hardLight(base, s)` を計算し、`error = |pred - result|` を求める
3. `error` が最小の `s` を候補集合に追加
4. 候補が複数なら **128との差の絶対値が最も小さいものを優先し、同点なら値が大きい方を採用する**
5. 採用した `s` とその `error` を返す（常に1解を返す）

RGBの3チャネルで `blend` を得て常に成功扱い。  
`totalError = errorR + errorG + errorB` を計算し、`totalError > 0` の場合は近似解としてUIに誤差を表示する。

---

## 5. 表示・状態設計

### 5.1 状態

- `idle`: 初期（基本色取得待ち）
- `basePicked`: 基本色取得済み（結果色取得待ち）
- `success`: 逆算成功・コピー完了
- `error`: エラー表示中（再試行可能）

### 5.2 状態遷移

- `idle` -> `basePicked`（基本色取得成功）
- `basePicked` -> `success`（結果色取得 + 逆算成功 + コピー成功）
- `basePicked` -> `error`（コピー失敗）
- 任意状態 -> `idle`（リセット操作）

### 5.3 UI文言

- 初期ボタン: `基本色のスポイトを開始`
- 次ボタン: `結果色を取得する`
- 成功トースト: `基本色と合成色がクリップボードに保存されました`
- 基本色取得失敗: `色の取得に失敗しました。もう一度お試しください`
- 結果色取得失敗: `色の取得に失敗しました。もう一度お試しください`
- 近似解通知: `基本色と合成色がクリップボードに保存されました。近似解を使用しました（誤差: R±{r}, G±{g}, B±{b}）`
- 非対応: `この環境ではスポイト機能を使用できません`
- コピー失敗: `クリップボードへの保存に失敗しました`

### 5.4 エラー文言マッピング

- `BASE_PICK_FAILED` -> 基本色取得失敗
- `RESULT_PICK_FAILED` -> 結果色取得失敗
- `APPROXIMATE_NOTICE` -> 近似解通知
- `COPY_FAILED` -> コピー失敗
- `UNSUPPORTED` -> 非対応

---

## 6. データ仕様

- 色文字列は常に小文字HEX（`#rrggbb`）
- 出力フォーマット（固定）:  
  `基本色: #rrggbb, 合成色: #rrggbb`

---

## 7. 技術構成（推奨ファイル構成）

- `manifest.json`
- `popup.html`
- `src/popup.ts`（状態制御・イベント）
- `src/color.ts`（HEX/RGB変換）
- `src/hardlight.ts`（正方向計算・逆算）
- `src/clipboard.ts`（コピー）
- `src/toast.ts`（トースト表示）
- `src/types.ts`
- `test/hardlight.test.ts`
- `test/color.test.ts`

---

## 8. Manifest要件（最小）

- `manifest_version: 3`
- `action.default_popup: "popup.html"`
- `permissions: ["clipboardWrite"]`

---

## 9. テスト要件

### 9.1 単体テスト

- `hardLight(base, blend)` の境界値（0,127,128,255）
- `base == 0` / `base == 255` 特例分岐での正方向計算・逆算
- 逆算:
  - 最小誤差候補の選択
  - 複数候補時の優先規則（128近傍・同点は大きい方）
- HEX変換:
  - 小文字固定
  - 先頭ゼロ保持

### 9.2 受け入れ条件

- 2回のスポイト後、成功時に必ずコピーされる
- コピー文字列が仕様フォーマットと一致
- 誤差がある場合は近似解通知がUIに表示される
- すべての表示文言が仕様通り
