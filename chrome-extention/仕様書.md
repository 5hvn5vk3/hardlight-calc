# ハードライト合成色逆算 Chrome 拡張 仕様書

## 1. 目的

- 画面上のカラーピッカー（EyeDropper）で `基本色` と `結果色` を順に取得する。
- 取得した 2 色からハードライトの `合成色` を逆算する。
- クリップボードへ `基本色` と `合成色` のカラーコードを保存する。
- 計算ロジックは `react-ver` / `vue-ver` の逆算式と一致させる。

## 2. 対象

- ブラウザ: Google Chrome（Manifest V3, EyeDropper API 対応）
- 実装言語: TypeScript
- 配置先: `chrome-extention` フォルダ

## 3. 用語

- 基本色: 下レイヤーの色（Base）
- 合成色: 上レイヤーの色（Composite, 逆算で求める値）
- 結果色: ハードライト適用後に見えている色（Result, 画面から取得）

## 4. 機能要件

1. 取得フロー開始

- ユーザーが拡張アイコンをクリックすると処理を開始する。
- 拡張機能起動時にポップアップを表示し、`基本色のスポイトを開始` ボタンを表示する。

2. 色の取得

- ポップアップの `基本色のスポイトを開始` を押すと、EyeDropper を起動する。
- EyeDropper 起動中はスポイト用カーソルに切り替わる。
- EyeDropper で `基本色` を取得する。
- 1回目のスポイト取得完了時点でカーソル形状を通常状態へ戻す。
- 1回目のスポイト完了後、`合成色のスポイトを開始` ボタンを含むポップアップを表示する。
- `合成色のスポイトを開始` を押すと、2回目の EyeDropper を起動し、スポイト用カーソルに切り替わる。
- 2回目の EyeDropper で `結果色` を取得する。
- 取得順序は固定（基本色 → 結果色）。

3. 合成色の逆算

- `基本色` と `結果色` から `合成色` をチャンネル単位で逆算する。
- R/G/B それぞれで 0-255 整数へ丸める。

4. クリップボード出力

- 逆算完了後、以下の形式でクリップボードへ書き込む。

```text
基本色:[16進数カラーコード] 合成色:[16進数カラーコード]
```

- `[16進数カラーコード]` には、取得した基本色と逆算した合成色をそれぞれ `#RRGGBB` 形式で入れる。
- クリップボード保存成功時は、以下の文言をポップアップで一時表示する。

```text
合成色の計算ができました。
基本色と合成色はクリップボードに記録されています。
```

5. 状態通知

- 処理中/成功/失敗/キャンセルを画面オーバーレイで表示する。
- クリップボード失敗時は失敗メッセージを表示する。

5. 入力補正

- RGB 値は 0-255 にクランプする。
- 不正入力（空、NaN）は直前の有効値または 0 として扱う。

## 5. 計算仕様（ハードライト逆算）

- 各チャンネル（R/G/B）を独立して計算する。
- `base`, `result` は各 0-255 の整数。
- `react-ver` / `vue-ver` と同じ逆算ロジックを採用する。

```ts
let S = 0.0;
let M = 0.0;

if (base === 255) {
  S = result === 255 ? 255 : -Infinity;
} else {
  S = (255 * (-2 * base + result + 255)) / (2 * (255 - base));
}

if (base !== 0) {
  M = (255 * result) / (2 * base);
}

const finalValue = base === 0 && result === 0 ? 127 : S >= 128 ? S : M;
const composite = clamp(round(finalValue), 0, 255);
```

- 最終結果:

```ts
compositeColor = {
  r: invert(base.r, result.r),
  g: invert(base.g, result.g),
  b: invert(base.b, result.b),
};
```

## 6. 画面仕様（Popup + Overlay）

- 拡張アイコンクリックでポップアップを表示する。
- ポップアップには `基本色のスポイトを開始` ボタンを配置する。
- `基本色のスポイトを開始` 完了後、`合成色のスポイトを開始` ボタンを含む次のポップアップを表示する。
- `合成色のスポイトを開始` 押下後、Webページ上に一時的な小型オーバーレイを表示する。
- 表示内容:

1. 現在ステップ（基本色を選択中 / 結果色を選択中）
2. 完了メッセージ（以下を一時表示）

```text
合成色の計算ができました。
基本色と合成色はクリップボードに記録されています。
```

3. エラー/キャンセルメッセージ

## 7. 拡張構成（実装方針）

- `manifest.json`（MV3）
- `popup.html`（`基本色のスポイトを開始` ボタンを表示）
- `src/popup.ts`（ボタンクリック時に処理開始メッセージを送信）
- `src/background.ts`（必要に応じたメッセージ中継）
- `src/content.ts`（EyeDropper実行、逆算、コピー、オーバーレイ表示）
- `src/types.ts`（RGB 型定義）
- `tsconfig.json`（TypeScript コンパイル設定）
- ビルド出力先: `dist/`（ロード対象）

## 8. 必要権限

- `activeTab`
  - 現在タブへ開始メッセージを送るため。
- `clipboardWrite`
  - 逆算結果をクリップボードへコピーするため。
- `host_permissions: <all_urls>`
  - コンテンツスクリプトを任意ページで動作させるため。

## 9. バリデーション・エラーハンドリング

- 計算前に RGB を整数化し 0-255 に収める。
- カラーコード変換時は常に 2 桁ゼロ埋めの大文字 HEX を出力。
- クリップボード書き込み失敗時は UI 上に失敗メッセージを表示。

## 10. 受け入れ条件

1. 拡張アイコンクリックでポップアップが開き、`基本色のスポイトを開始` ボタンが表示される。
2. `基本色のスポイトを開始` 押下で EyeDropper が開始され、カーソル形状がスポイト用に変わる。
3. 1回目のスポイト完了後、カーソル形状が通常状態に戻り、`合成色のスポイトを開始` ボタンが表示される。
4. `合成色のスポイトを開始` 押下で2回目の EyeDropper が開始され、カーソル形状がスポイト用に変わる。
5. 基本色と結果色を取得すると、合成色が逆算される。
6. クリップボードに `基本色:[16進数カラーコード] 合成色:[16進数カラーコード]` の 1 行テキストが保存される。
7. クリップボード保存成功後、以下メッセージのポップアップが一時表示される。

```text
合成色の計算ができました。<br>
基本色と合成色はクリップボードに記録されています。
```

8. 逆算結果 RGB は常に 0-255 整数となる。

## 11. 将来拡張（任意）

- 計算履歴（セッション中の直近 N 件）
- 16進直接入力欄
- 他合成モード（スクリーン、オーバーレイ等）対応
