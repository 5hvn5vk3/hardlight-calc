# ハードライト合成色逆算 Chrome 拡張 仕様書（Popupなし）

## 1. 目的
- 画面上のカラーピッカー（EyeDropper）で `基本色` と `結果色` を順に取得する。
- 取得した 2 色からハードライトの `合成色` を逆算する。
- クリップボードへ `基本色` と `合成色` のカラーコードを保存する。
- 計算ロジックは `react-ver` / `vue-ver` の逆算式と一致させる。

## 2. 対象
- ブラウザ: Google Chrome（Manifest V3, EyeDropper API 対応）
- 実装言語: TypeScript
- 配置先: `chrome-extention` フォルダ

## 3. 用語
- 基本色: 下レイヤーの色（Base）
- 合成色: 上レイヤーの色（Composite, 逆算で求める値）
- 結果色: ハードライト適用後に見えている色（Result, 画面から取得）

## 4. 機能要件
1. 取得フロー開始
- ユーザーが拡張アイコンをクリックすると処理を開始する。
- Popup UI は使用しない。

2. 色の取得
- EyeDropper で `基本色` を取得する。
- 続いて EyeDropper で `結果色` を取得する。
- 取得順序は固定（基本色 → 結果色）。

3. 合成色の逆算
- `基本色` と `結果色` から `合成色` をチャンネル単位で逆算する。
- R/G/B それぞれで 0-255 整数へ丸める。

4. クリップボード出力
- 逆算完了後、以下の形式でクリップボードへ書き込む。
```text
基本色:[16進数カラーコード] 合成色:[16進数カラーコード]
```
- `[16進数カラーコード]` には、取得した基本色と逆算した合成色をそれぞれ `#RRGGBB` 形式で入れる。

5. 状態通知
- 処理中/成功/失敗/キャンセルを画面オーバーレイで表示する。
- クリップボード失敗時は失敗メッセージを表示する。

5. 入力補正
- RGB 値は 0-255 にクランプする。
- 不正入力（空、NaN）は直前の有効値または 0 として扱う。

## 5. 計算仕様（ハードライト逆算）
- 各チャンネル（R/G/B）を独立して計算する。
- `base`, `result` は各 0-255 の整数。
- `react-ver` / `vue-ver` と同じ逆算ロジックを採用する。

```ts
let S = 0.0;
let M = 0.0;

if (base === 255) {
  S = result === 255 ? 255 : -Infinity;
} else {
  S = (255 * (-2 * base + result + 255)) / (2 * (255 - base));
}

if (base !== 0) {
  M = (255 * result) / (2 * base);
}

const finalValue = base === 0 && result === 0 ? 127 : (S >= 128 ? S : M);
const composite = clamp(round(finalValue), 0, 255);
```

- 最終結果:
```ts
compositeColor = {
  r: invert(base.r, result.r),
  g: invert(base.g, result.g),
  b: invert(base.b, result.b),
};
```

## 6. 画面仕様（Overlay）
- ポップアップは使わず、Webページ上に一時的な小型オーバーレイを表示する。
- 表示内容:
1. 現在ステップ（基本色を選択中 / 結果色を選択中）
2. 完了メッセージ（コピー済み）
3. エラー/キャンセルメッセージ

## 7. 拡張構成（実装方針）
- `manifest.json`（MV3）
- `src/background.ts`（拡張アイコンクリックを受け取り、処理開始メッセージを送信）
- `src/content.ts`（EyeDropper実行、逆算、コピー、オーバーレイ表示）
- `src/types.ts`（RGB 型定義）
- `tsconfig.json`（TypeScript コンパイル設定）
- ビルド出力先: `dist/`（ロード対象）

## 8. 必要権限
- `activeTab`
  - 現在タブへ開始メッセージを送るため。
- `clipboardWrite`
  - 逆算結果をクリップボードへコピーするため。
- `host_permissions: <all_urls>`
  - コンテンツスクリプトを任意ページで動作させるため。

## 9. バリデーション・エラーハンドリング
- 計算前に RGB を整数化し 0-255 に収める。
- カラーコード変換時は常に 2 桁ゼロ埋めの大文字 HEX を出力。
- クリップボード書き込み失敗時は UI 上に失敗メッセージを表示。

## 10. 受け入れ条件
1. 拡張アイコンクリックで EyeDropper が開始される。
2. 基本色と結果色を取得すると、合成色が逆算される。
3. クリップボードに `基本色:[16進数カラーコード] 合成色:[16進数カラーコード]` の 1 行テキストが保存される。
4. 逆算結果 RGB は常に 0-255 整数となる。
5. Popup を使わず、タブ上操作のみで完結する。

## 11. 将来拡張（任意）
- 計算履歴（セッション中の直近 N 件）
- 16進直接入力欄
- 他合成モード（スクリーン、オーバーレイ等）対応
